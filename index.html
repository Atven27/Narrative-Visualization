<!DOCTYPE html>
<html lang="en">
<script src="https://d3js.org/d3.v7.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3-annotation/2.5.1/d3-annotation.min.js"></script>
<head>
    <meta charset="UTF-8">
    <title>2017 Automobile Fuel Efficiency Narrative Visualization</title>
    <link href="page.css" type="text/css" rel="stylesheet" />
</head>
<style> circle {fill: lightblue; stroke: black;} </style>
<body onload="init()">
<h1>2017 Automobile Fuel Efficiency Narrative Visualization</h1><br/>
<label for="select_scene">Select a chart: </label>

<button id="scene1_btn">Chart 1</button>
<button id="scene2_btn">Chart 2</button>
<button id="scene3_btn">Chart 3</button>
<span></span>
<p>Hover over data points to see more information</p>
<svg width=1800 height=800>
    
</svg>

<script>
async function init() {

    const data = await d3.csv("cars2017.csv");
    const cylinders = [0,2,3,4,6,8,10,12]
    
    // Setup dictionary for the different cylinder numbers of each car
    var dict = {}
    cylinders.forEach(function (item,index) {
        cyl = {}
        cyl["count"] = 0
        cyl["avgHighMPG"] = 0
        cyl["avgCityMPG"] = 0
        dict[item] = cyl
    });

    // Populate dictionary with number of cars with that number cylinder, avg highwaympg for that cylinder, and avg city mpg for that cylinder
    for (i=0; i < data.length; i++) {
        
        c = Number(data[i].EngineCylinders)
        himpg = Number(data[i].AverageHighwayMPG)
        cimpg = Number(data[i].AverageCityMPG)

        dict[c]["count"] += 1 
        dict[c]["avgHighMPG"] += himpg
        dict[c]["avgCityMPG"] += cimpg
         
    }
    
    cylinders.forEach(function (item,index) {
        dict[item]["avgHighMPG"] = (dict[item]["avgHighMPG"] / dict[item]["count"]).toFixed(2)
        dict[item]["avgCityMPG"] = (dict[item]["avgCityMPG"] / dict[item]["count"]).toFixed(2)
    });
    
    console.log(dict)
    



    function draw_chart1_annotations() {

        const annotations1 = [
        {   
            type: d3.annotationCallout,
            note: {
                label: "Cars with zero cylinders are electric",
                title: "Electric",
                wrap: 300,
                bgPadding: {"top":0.5,"left":1,"right":1,"bottom":1}
                
            },
            
            x: 180,
            y: 680,
            dy: 40,
            dx: 10,
            

        },
        {
            type: d3.annotationCalloutElbow,
            note: {
                label: "As the number of cylinders increase both the city and highway mpg seems to decrease",
                title: "General Trend",
                wrap: 300,
                bgPadding: {"top":0.5,"left":1,"right":1,"bottom":0.5}
                
            },
            subject: {
                x1: 840,
                x2: 1200
            },
            
            x: 900,
            y: 450,
            dy: -20,
            dx: 40,
        }].map(function(d){ d.color = "black"; return d})


        const makeAnnotations = d3.annotation()
        .type(d3.annotationLabel)
        .annotations(annotations1)

        d3.select("svg")
        .append("g")
        .attr("class", "annotation-group")
        .call(makeAnnotations)
    }
        














    // Chart 1 & 2
    var x = d3.scaleBand().domain([0,1,2,3,4,5,6,7]).range([0,1700])
    var y = d3.scaleLinear().domain([10,150]).range([600,0])
    var dlist = Object.entries(dict);
    
    // Chart 3
    var scatter_x = d3.scaleLinear().domain([10,150]).range([0,1700])
    var scatter_y = d3.scaleLinear().domain([10,150]).range([600,0])

    function draw_axis(scene) {
        let x_axis_title;
        let y_axis_title;

        if (scene == 1) {
            y_axis_title = "Average Highway MPG"
        }
        else if (scene == 2) {
            y_axis_title = "Average City MPG"
        }
        
        d3.select('svg')
        .append("g")
        .attr("transform","translate(70,50)")
        .call(d3.axisLeft(y).tickFormat(d3.format("~s")));
        
        d3.select('svg')
        .append("g")
        .attr("transform","translate(70,650)")
        .call(d3.axisBottom(x).tickFormat(function(d,i){ return cylinders[i]}));

        // Learned how to create axis titles: https://d3-graph-gallery.com/graph/custom_axis.html
        d3.select("svg").append("text")
        .attr("text-anchor", "end")
        .attr("x", 1000)
        .attr("y", 700)
        .style('fill', 'Black')
        .style('font-weight', 'bold')
        .text("Engine Cylinder Count")

        d3.select("svg").append("text")
        .attr("text-anchor", "end")
        .attr("x", -200)
        .attr("y", 15)
        .attr("dy", ".25em")
        .style('fill', 'Black')
        .style('font-weight', 'bold')
        .attr("transform", "rotate(-90)")
        .text(y_axis_title);
    }
    
    function draw_scatter_axis() {
        d3.select('svg')
        .append("g")
        .attr("transform","translate(70,50)")
        .call(d3.axisLeft(scatter_y).tickFormat(d3.format("~s")));
        
        d3.select('svg')
        .append("g")
        .attr("transform","translate(70,650)")
        .call(d3.axisBottom(scatter_x).tickFormat(d3.format("~s")));

        d3.select("svg").append("text")
        .attr("text-anchor", "end")
        .attr("x", 1000)
        .attr("y", 700)
        .style('fill', 'Black')
        .style('font-weight', 'bold')
        .text("Average City MPG")

        d3.select("svg").append("text")
        .attr("text-anchor", "end")
        .attr("x", -200)
        .attr("y", 15)
        .attr("dy", ".25em")
        .style('fill', 'Black')
        .style('font-weight', 'bold')
        .attr("transform", "rotate(-90)")
        .text("Average Highway MPG");
    }

    // Define the div for the tooltip
    var tooltip = d3.select("body").append("div")
    .attr("class", "tooltip")
    .style("opacity", 0);



    function update_scene(scene) {
        d3.select("span").html("Chart " + scene + " selected")
        d3.select("svg").html("");
        
        var svg = d3.select("svg")
        .append("g")
        .attr("transform","translate(70,50)");
        
        if (scene == 1) {
            svg.selectAll('rect')
            .data(dlist)
            .enter()
            .append('rect')
            .attr('x', function(d,i) {return x(i);})
            .attr('y', function(d,i) {return y(d[1].avgHighMPG);})
            .attr('width', x.bandwidth())
            .attr('height',function(d,i) {return 600 - y(d[1].avgHighMPG);})
            // Had help setting up tooltips from here: https://bl.ocks.org/d3noob/a22c42db65eb00d4e369
            .on("mouseover", function(index, data) {
             
                d3.select(this).transition()
               .duration('50')
               .attr('opacity', '.5');

                tooltip.transition()
                .duration(200)
                .style("opacity", 0.9);
                tooltip.html(
                    "Average Highway MPG: " + data[1].avgHighMPG
                    + "<br/> Number of cars: " + data[1].count
                    )
                .style("left", (event.pageX) + "px")
                .style("top", (event.pageY - 28) + "px");
            })
            
            .on("mouseout", function(d) {
                
                d3.select(this).transition()
               .duration('50')
               .attr('opacity', '1');

                tooltip.transition()
                .duration(200)
                .style("opacity", 0);
            });
            draw_chart1_annotations();
            draw_axis(scene);
        }

        else if (scene == 2) {
            svg.selectAll('rect')
            .data(dlist)
            .enter()
            .append('rect')
            .attr('x', function(d,i) {return x(i);})
            .attr('y', function(d,i) {return y(d[1].avgCityMPG);})
            .attr('width', x.bandwidth())
            .attr('height',function(d,i) {return 600 - y(d[1].avgCityMPG);})
            .on("mouseover", function(index, data) {
                
                d3.select(this).transition()
               .duration('50')
               .attr('opacity', '.5');

                tooltip.transition()
                .duration(200)
                .style("opacity", 0.9);
                tooltip.html(
                    "Average City MPG: " + data[1].avgCityMPG
                    + "<br/> Number of cars: " + data[1].count
                    )
                .style("left", (event.pageX) + "px")
                .style("top", (event.pageY - 28) + "px");
            })
            
            .on("mouseout", function(d) {
                
                d3.select(this).transition()
               .duration('50')
               .attr('opacity', '1');

                tooltip.transition()
                .duration(200)
                .style("opacity", 0);
            });
            draw_chart1_annotations();
            draw_axis(scene);
                
        }
        else { 
            svg.selectAll('circle')
            .data(data)
            .enter()
            .append('circle')
            .attr('cx', function(d,i) {return scatter_x(d.AverageCityMPG);})
            .attr('cy', function(d,i) {return scatter_y(d.AverageHighwayMPG);})
            .attr('r', function(d,i) { return Number(d.EngineCylinders) + 5;})
            .on("mouseover", function(index, data) {
                
                d3.select(this).transition()
               .duration('50')
               .attr('opacity', '.5');

                tooltip.transition()
                .duration(200)
                .style("opacity", 0.9);
                tooltip.html(
                    "Avg. City MPG: " + data.AverageCityMPG 
                    + "<br/> Avg. Highway MPG: " + data.AverageHighwayMPG 
                    + "<br/> Fuel Type: " + data.Fuel
                    + "<br/> Cylinders: " + data.EngineCylinders
                    + "<br/> Make: " + data.Make
                    )
                .style("left", (event.pageX) + "px")
                .style("top", (event.pageY - 28) + "px");
            })
            
            .on("mouseout", function(d) {
                
                d3.select(this).transition()
               .duration('50')
               .attr('opacity', '1');

                tooltip.transition()
                .duration(200)
                .style("opacity", 0);
            });

            svg.append('line')
            .style("stroke", "lightgrey")
            .style("stroke-width", 5)
            .style("stroke-dasharray", ("8, 8"))
            .style("opacity", 0.5)
            .attr("x1", 0)
            .attr("y1", 600)
            .attr("x2", 1700)
            .attr("y2", 0); 
            
            draw_scatter_axis();
        }
        
    }



    update_scene(3);


    var btn1 = d3.select("#scene1_btn");
    btn1.on("click", function() {  
        update_scene(1);
    });

    var btn2 = d3.select("#scene2_btn");
    btn2.on("click", function() {
        update_scene(2);
    });

    var btn3 = d3.select("#scene3_btn");
    btn3.on("click", function() {
        update_scene(3);
    });

    
}   
</script>
</body>
</html>